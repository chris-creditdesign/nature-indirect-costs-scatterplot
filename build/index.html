<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Polopoly</title>
	<script src="http://nature.com/view/scripts/jquery/jquery-1.7.2.min.js" type="text/javascript"></script>
	<!-- <script src="https://poly-admin1.nature.com/polopoly_static/js/jquery-1.6.4.js" type="text/javascript"></script> -->

	<link rel="stylesheet" type="text/css" href="polopoly/reset.css" />
	<link rel="stylesheet" type="text/css" href="polopoly/html5.css" />
	<link rel="stylesheet" type="text/css" href="polopoly/layout.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/header.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/footer.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/main.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/news-main.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/comments.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/mobile.css" />	



</head>


<!--[if lt IE 6]><body class="lt-ie6"><![endif]-->
<!--[if IE 6]><body class="ie6"><![endif]-->
<!--[if IE 7]><body class="ie7"><![endif]-->
<!--[if IE 8]><body class="ie8"><![endif]-->
<!--[if gt IE 8]><body class="gt-ie8"><![endif]-->
<!--[if !IE]>--><body><!--<![endif]-->

<div id="constrain">

<div id="main">
	<div id="constrain-content" class="cleared">
		<div id="content" class="col">
			<article>
				<div id="article">
					<section>
						<div class="section">
							<div class="html-widget img-rigth">

<!-- ========= PASTED POLOPOLY HEADER ABOVE ========= -->







<style scoped>
.status-message {
  border: 1px solid #c00;
  background: #fac7c7;
  padding: 10px;
  display: none; }

.js-disabled .status-message, .ie6 .status-message, .ie7 .status-message, .ie8 .status-message {
  display: block; }

.outer-wrapper {
  width: 100%;
  position: relative;
  border: 1px solid #c8c7cf;
  display: none; }
  .outer-wrapper h2 {
    padding: 10px 10px 0 10px;
    margin: 0; }
  .outer-wrapper h3 {
    padding: 0 10px;
    margin: 0; }
  .outer-wrapper p {
    padding: 10px;
    margin: 0; }
  .outer-wrapper .axis path, .outer-wrapper .axis line {
    fill: none;
    stroke: #666;
    shape-rendering: crispEdges; }
  .outer-wrapper .axis text {
    font-family: sans-serif;
    fill: #666;
    font-size: 13px;
    shape-rendering: crispEdges; }
  .outer-wrapper .key {
    margin-left: 30px; }
  .outer-wrapper .palette {
    border-left: 20px solid;
    padding-left: 4px;
    display: inline-block;
    margin: 10px; }

</style>
<div class="status-message">
	<p>This interactive graphic requires a modern browser (e.g. Chrome, Safari, Firefox or Internet Explorer 9+) with javascript enabled.</p>
	<p>The TK can be downloaded here: <a href="#" title="#" class="file-icon xls-icon">Web of Science Top 100.xls</a></p>
</div>

<div class="outer-wrapper" id="idc-graphic">
	<h2>Negotiated Indirect Cost vs Actual Calculated Indirect Cost</h2>

	<div class="chart"></div>

	<div class="key" id="key"></div>

	<div class="choose-state" id="states"></div>

</div>
<!--[if gt IE 8]><!-->
<script type="text/javascript">
function extendObject (myObject) {
	/*	Referenced from: http://addyosmani.com/resources/essentialjsdesignpatterns/book/#observerpatternjavascript */
	
	/*	Storage for topics that can be broadcast or listened to */
	var topics = {};

	/*	A topic identifyer */
	var subUid = -1;

	/*	Publish or broadcast events of interest
		with a specific topic name and arguments
		such as the data to pass along */
	myObject.publish = function ( topic, args ) {
		
		if ( !topics[topic] ) {
			return false;
		}

		var subscribers = topics[topic];
		var len = subscribers ? subscribers.length : 0;

		while (len--) {
			subscribers[len].func( topic, args );
		}	

		return this;
	};

	/*	Subscribe to events of interest with a specific topic name and a 
		callback function, to be executed with the topic/event is observed */
	myObject.subscribe = function ( topic, func, parent ) {
		
		if ( !topics[topic] ) {
			topics[topic] = [];
		}

		var token = ( ++subUid ).toString();
		topics[topic].push({
			token: token,
			func: func,
			parent: parent
		});
		return token;
	};

}
function buildParams () {
	var params = {};

	params.colour =  [	"#88be3d", /* Higher Ed */
						"#01a4c6", /* Hosp */
						"#e9bb09", /* NP res inst */
						"#ab2715"  /* Other */
					];

	/*	Margin, Width and height */
	params.margin = {top: 20, right: 20, mid: 30, bottom: 50, left: 50};
	params.brushThickness = 30;
	params.width = jQuery('.section').width()  - params.margin.left - params.brushThickness - params.margin.mid - params.margin.right;
	params.height = jQuery('.section').width() - params.margin.top - params.margin.mid - params.brushThickness - params.margin.bottom;
	params.startExtent = [25,75];
	params.fullExtent = [0,105];
	params.fullExtentInvert = [105,0];

	return params;
}

BuildWidget.prototype.buttonClick = function() {
	var self = this;

};

BuildWidget.prototype.upDateButtons = function () {
	var self = this;
};
function ifNaNmakeZero (num) {
	if (isNaN(num)) {
		num = 0;
	}
	return num;
}


function buildData (data) {

	var institutionTypesArray = [];
	var statesArray = [];
	var filteredData = [];
	var statesSet;
	var institutionTyesSet;
	

	for (var i = 0; i < data.length; i++) {
		statesArray.push(data[i].state);

		data[i].floatFY12 = data[i].FY12.length > 0 ? parseFloat(data[i].FY12) : 0;
		data[i].floatFY12 = ifNaNmakeZero(data[i].floatFY12);
		
		data[i].floatFY13 = data[i].FY13.length > 0 ? parseFloat(data[i].FY13) : 0;
		data[i].floatFY13 = ifNaNmakeZero(data[i].floatFY13);
		
		data[i].floatCalculated_indirect_cost = parseFloat(data[i].calculated_indirect_cost);
		data[i].floatCalculated_indirect_cost = ifNaNmakeZero(data[i].floatCalculated_indirect_cost);

		data[i].intDirect_cost = parseInt(data[i].direct_cost, 10);
		data[i].intDirect_cost = ifNaNmakeZero(data[i].intDirect_cost);

		data[i].intIndirect_cost = parseInt(data[i].indirect_cost, 10);
		data[i].intIndirect_cost = ifNaNmakeZero(data[i].intIndirect_cost);
		
		data[i].intFunding = parseInt(data[i].funding, 10);
		data[i].intFunding = ifNaNmakeZero(data[i].intFunding);
	}

	statesSet = d3.set(statesArray).values();

	data.forEach(function (element, array, index) {
		if (element.funding > 1000000 && element.floatFY13 && element.floatCalculated_indirect_cost > 0) {
			filteredData.push(element);
		}
	});

	for (var j = 0; j < filteredData.length; j++) {
		institutionTypesArray.push(filteredData[j].institution_type);
	}
	
	institutionTyesSet = d3.set(institutionTypesArray).values();

	return {
		data: data,
		filteredData: filteredData,
		type: institutionTyesSet,
		state: statesSet
	};
}
function BuildWidget (target, params, data) {
	this.target = target;
	this.params = params;
	this.data = data;
}


BuildWidget.prototype.buildScales = function () {
	
	var maxValue = d3.max(this.data.filteredData, function(d) { 
		return d.intFunding; 
	});

	this.yScale = d3.scale.linear()
					.range([this.params.height, 0])
					.domain(this.params.startExtent);

	this.yBrushScale = d3.scale.linear()
					.range([this.params.height, 0])
					.domain(this.params.fullExtent);

	this.xScale = d3.scale.linear()
					.range([0, this.params.width])
					.domain(this.params.startExtent);

	this.xBrushScale = d3.scale.linear()
					.range([0, this.params.width])
					.domain(this.params.fullExtent);

	this.radiusScale = d3.scale.sqrt()
						.range([2,15])
						.domain([1000000, maxValue]);

	this.yMiniMapScale = d3.scale.linear()
						.range([this.params.brushThickness, 0])
						.domain(this.params.fullExtent);

	this.yMiniMapInvertScale = d3.scale.linear()
						.range([this.params.brushThickness, 0])
						.domain(this.params.fullExtentInvert);

	this.xMiniMapScale = d3.scale.linear()
							.range([0, this.params.brushThickness])
							.domain(this.params.fullExtent);

	this.typeColourScale = d3.scale.ordinal()
							.domain(this.data.type)
							.range(this.params.colour);

};

BuildWidget.prototype.buildGraphic = function () {
	this.svg = d3.select(this.target  + " > .chart").append("svg")
		.attr("width", this.params.width + this.params.margin.left + this.params.brushThickness + this.params.margin.mid + this.params.margin.right)
		.attr("height", this.params.height + this.params.margin.top + this.params.brushThickness + this.params.margin.mid + this.params.margin.bottom);

	var clip = this.svg.append("defs").append("svg:clipPath")
					.attr("id", "clip")
				  .append("svg:rect")
					.attr("x", 0)
					.attr("y", 0)
					.attr("width", this.params.width)
					.attr("height", this.params.height);

	var miniClip = this.svg.append("defs").append("svg:clipPath")
					.attr("id", "mini-clip")
				  .append("svg:rect")
					.attr("x", 0)
					.attr("y", 0)
					.attr("width", this.params.brushThickness)
					.attr("height", this.params.brushThickness);


	this.scatterGroup = this.svg.append("g")
							.attr("class","scatterGroup")
							.attr("clip-path", "url(#clip)")
							.attr("transform","translate(" + (this.params.margin.left + this.params.brushThickness + this.params.margin.mid) + "," + this.params.margin.top + ")");

	this.radiusGroup = this.svg.append("g")
							.attr("class","radiusGroup")
							.attr("transform","translate(" + (this.params.margin.left + this.params.brushThickness + this.params.margin.mid) + "," + this.params.margin.top + ")");


	this.xBrushGroup = this.svg.append("g")
							.attr("class","xBrushGroup")
							.attr("transform","translate(" + (this.params.margin.left + this.params.brushThickness + this.params.margin.mid) + "," + (this.params.margin.top + this.params.height + this.params.margin.mid)+ ")");

	this.yBrushGroup = this.svg.append("g")
							.attr("class","yBrushGroup")
							.attr("transform","translate(" + this.params.margin.left + "," + this.params.margin.top + ")");

	this.miniMapGroup = this.svg.append("g")
							.attr("class","miniMapGroup")
							.attr("clip-path", "url(#mini-clip)")
							.attr("transform","translate(" + this.params.margin.left + "," + (this.params.margin.top + this.params.height + this.params.margin.mid) + ")");

	this.mapperGroup = this.svg.append("g")
							.attr("class","miniMapGroup")
							.attr("transform","translate(" + this.params.margin.left + "," + (this.params.margin.top + this.params.height + this.params.margin.mid) + ")");
};

BuildWidget.prototype.buildAxes = function () {
	this.yAxis = d3.svg.axis()
					.scale(this.yScale)
					.tickSize(3,0)
					.orient("left");

	this.yBrushAxis = d3.svg.axis()
					.scale(this.yBrushScale)
					.tickSize(3,0)
					.orient("left");

	this.xAxis = d3.svg.axis()
					.scale(this.xScale)
					.tickSize(3,0)
					.orient("bottom");

	this.xBrushAxis = d3.svg.axis()
					.scale(this.xBrushScale)
					.tickSize(3,0)
					.orient("bottom");

	/* Prepare the y axis */
	this.svg.append("g")
		.attr("class", "y axis")
		.attr("transform", "translate(" + (this.params.margin.left + this.params.brushThickness + this.params.margin.mid) + "," + this.params.margin.top + ")")
		.call(this.yAxis);

	this.svg.append("g")
		.attr("class", "y-brush axis")
		.attr("transform", "translate(" + this.params.margin.left + "," + this.params.margin.top + ")")
		.call(this.yBrushAxis)	
	  .append("g")
		.attr("class", "axisLabel")
	  .append("text")
		.attr("transform", "translate(" + -(this.params.margin.left * 0.6) + "," + (this.params.height / 2) + "), rotate(-90)")
		.style("text-anchor", "middle")
		.text("Actual Indirect Cost (%)");

	/*	Prepare the x axis */
	this.svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(" + (this.params.margin.left + this.params.brushThickness + this.params.margin.mid) + "," + (this.params.margin.top + this.params.height) + ")")
		.call(this.xAxis)

	this.svg.append("g")
		.attr("class", "x-brush axis")
		.attr("transform", "translate(" + (this.params.margin.left + this.params.brushThickness + this.params.margin.mid) + "," + (this.params.margin.top + this.params.height + this.params.margin.mid + this.params.brushThickness) + ")")
		.call(this.xBrushAxis)	
	  .append("g")
		.attr("class","axisLabel")
	  .append("text")
		.attr("transform", "translate(" + (this.params.width / 2) + "," + (this.params.margin.bottom * 0.7) + ")")
		.style("text-anchor","middle")
		.text("Negotiated Indirect Cost (%)");
		
};

BuildWidget.prototype.buildBrush = function () {
	var self = this;

	var updateView = function () {
		self.updateScatterPlot();
		self.svg.selectAll(".x.axis").call(self.xAxis);
		self.svg.selectAll(".y.axis").call(self.yAxis);
		self.updateMiniMap(xBrush.extent(), yBrush.extent());

	};

	var xDisplay = function () {
		var extent = xBrush.extent();

		self.xScale.domain(extent);

		updateView();
	};

	var xBrushend = function () {
		if (xBrush.extent()[0] === xBrush.extent()[1]) {
			d3.select(this).call(xBrush.extent(self.params.fullExtent));
			self.xScale.domain(self.params.fullExtent);

			updateView();
		}
	};

	var yDisplay = function () {
		var extent = yBrush.extent();

		self.yScale.domain(extent);

		updateView();
		
	};

	var yBrushend = function () {
		if (yBrush.extent()[0] === yBrush.extent()[1]) {
			d3.select(this).call(yBrush.extent(self.params.fullExtent));
			self.yScale.domain(self.params.fullExtent);

			updateView();
		}
	};

	var xBrush = d3.svg.brush()
					.x(this.xBrushScale)
					.extent(this.params.startExtent)
					.on("brush", xDisplay)
					.on("brushend", xBrushend);

	var yBrush = d3.svg.brush()
					.y(this.yBrushScale)
					.extent(this.params.startExtent)
					.on("brush", yDisplay)
					.on("brushend", yBrushend)

	this.xBrushGroup.append("g")
		.attr("class", "brush")
		.call(xBrush)
		.selectAll("rect")
		.attr("fill","#999")
		.attr("height", this.params.brushThickness );

	this.yBrushGroup.append("g")
		.attr("class", "brush")
		.call(yBrush)
		.selectAll("rect")
		.attr("fill", "#999")
		.attr("width", this.params.brushThickness)

};

BuildWidget.prototype.enterScatterPlot = function (target, main) {
	var self = this;

	target.selectAll("circle")
			.data(this.data.filteredData, function (d) {
				return d.organization_name;
			})
			.enter()
		  .append("circle")
			.attr("cx", function (d) {
				return main ? self.xScale(d.floatFY13) : self.xMiniMapScale(d.floatFY13);
			})
			.attr("cy", function (d) {
				return main ? self.yScale(d.floatCalculated_indirect_cost) : self.yMiniMapScale(d.floatCalculated_indirect_cost);
			})
			.attr("r", function (d) {
				return main ? self.radiusScale(d.intFunding) : 0.5;
			})
			.attr("opacity", 0.8)
			.attr("fill", function (d) {
				return self.typeColourScale(d.institution_type);
			});
};

BuildWidget.prototype.clickScatterPlot = function () {
	var self = this;

	this.scatterGroup.selectAll("circle")
		.on("click", function (d) {
			console.log(d.organization_name + " Funding: $" + d.intFunding + " Negotiated indirect cost rate: " + d.floatFY13 + "% Calculated indirect cost rate: " + d.floatCalculated_indirect_cost + "%");
		});
};

BuildWidget.prototype.updateScatterPlot = function () {
	var self = this;

	this.scatterGroup.selectAll("circle")
			.attr("cx", function (d) {
				return self.xScale(d.floatFY13);
			})
			.attr("cy", function (d) {
				return self.yScale(d.floatCalculated_indirect_cost);
			});

};

BuildWidget.prototype.buildMiniMap = function () {
	var self = this;

	this.miniMapGroup.append("rect")
					.attr("x", 0)
					.attr("y", 0)
					.attr("width", this.params.brushThickness)
					.attr("height", this.params.brushThickness)
					.attr("fill","#eee")
					.attr("stroke","none");

	this.mapper = this.mapperGroup.append("rect")
						.attr("x", function () {
							return self.xMiniMapScale(self.params.startExtent[0])
						})
						.attr("y", function () {
							var top = self.params.fullExtent[1] - self.params.startExtent[1];
							return self.yMiniMapInvertScale(top);
						})
						.attr("width", function () {
							var width = self.params.startExtent[1] - self.params.startExtent[0];
							return self.xMiniMapScale(width);
						})
						.attr("height", function () {
							var height = self.params.startExtent[1] - self.params.startExtent[0];
							return self.yMiniMapInvertScale(height);
						})
						.attr("fill","none")
						.attr("stroke","#333")
						.attr("storke-width","1px");
};

BuildWidget.prototype.updateMiniMap = function(x, y) {
	var self = this;

	this.mapper
			.attr("x", function() {
				return self.xMiniMapScale(x[0]);
			})
			.attr("y", function() {
				var top = self.params.fullExtent[1] - y[1];
				return self.yMiniMapInvertScale(top);
			})
			.attr("width", function () {
				var width = x[1] - x[0];
				return self.xMiniMapScale(width);
			})
			.attr("height", function () {
				var height = y[1] - y[0];
				return self.yMiniMapInvertScale(height);
			});
};

BuildWidget.prototype.buildColourKey = function (target) {
	var self = this;

	d3.select(target)
	  .append("ul")
		.selectAll("li")
		.data(self.data.type)
		.enter()
	  .append("li")
		.attr("class", "palette")
		.attr("title", function(d) { return d.key; })
		.text(function(d) {
			return d;
		})
		.style("border-color", function(d) {
			return self.typeColourScale(d)
		});
};

BuildWidget.prototype.buildRadiusKey = function (target) {
	var self = this;

	var keyRange = [1000000,100000000, 600000000];

	target.selectAll("circle")
		.data(keyRange)
		.enter()
		.append("circle")
		.attr("cx", (self.params.height - 20))
		.attr("cy", (self.params.width - 20))
		.attr("r", function(d) {
			return self.radiusScale(d);
		})
		.style("stroke", "#999")
		.style("stroke-width", 1.5)
		.style("fill", "none");
};


BuildWidget.prototype.buildCheckboxes = function (target) {
	var self = this;

	/* Create checkboxes for each site */
	d3.select(target)
		.append("ul")
		.attr("id","select")
		.selectAll('li')
	  .data(self.data.state)
	  	.enter()
		.append("li")
		.html(function (d, i) {
			var checked = 'checked';
			
			var safeName = d.toLowerCase().split(' ').join("_");

			var innerHTML = "<input type='checkbox' id='" + safeName + "' name='select' " + checked + "><label for='" + safeName + "'> " + d + "</label>";

			return innerHTML;
		});
};

(function() {
		var init = function($)
		{
		/*	Both jQuery and D3 are available so hide the status message and show the graphic */
		$(".status-message").css("display","none");
		$(".outer-wrapper").css("display","block");

			/*	Load D3 */
			$.getScript("http://d3js.org/d3.v3.min.js", function() {


				d3.csv("data/indirect-costs-calculated.csv", function (data) {
					var params = buildParams();

					var idcData = buildData(data);			

					var idcGraphic = new BuildWidget("#idc-graphic", params, idcData);

					idcGraphic.buildGraphic();
					idcGraphic.buildScales();
					idcGraphic.buildAxes();
					idcGraphic.buildBrush();
					idcGraphic.buildMiniMap();
					idcGraphic.enterScatterPlot(idcGraphic.scatterGroup, true);
					idcGraphic.clickScatterPlot();
					idcGraphic.enterScatterPlot(idcGraphic.miniMapGroup, false);

					idcGraphic.buildColourKey("#key");
					idcGraphic.buildRadiusKey(idcGraphic.radiusGroup);
					// idcGraphic.buildCheckboxes("#states");
				});

			}); /* End of d3js getscript call

		/* End of active code */
		};

	setTimeout(function()
	{
	if (typeof jQuery !== 'undefined')
	{
		init(jQuery);
	} else
	{
		setTimeout(arguments.callee, 60);
	}
	}, 60);

})();
</script>
<!--<![endif]-->
<!-- ========= PASTED POLOPOLY FOOTER BELOW ========= -->

</div>							
						</div>
					</section>
				</div>
			</article>
		</div>
	</div>
</div>
</div>
</body>
</html>