<style scoped>
.status-message {
  border: 1px solid #c00;
  background: #fac7c7;
  padding: 10px;
  display: none; }

.js-disabled .status-message, .ie6 .status-message, .ie7 .status-message, .ie8 .status-message {
  display: block; }

.outer-wrapper {
  width: 100%;
  position: relative;
  border: 1px solid #c8c7cf;
  display: none; }
  .outer-wrapper h2 {
    padding: 10px 10px 0 10px;
    margin: 0; }
  .outer-wrapper h3 {
    padding: 0 10px;
    margin: 0; }
  .outer-wrapper p {
    padding: 10px;
    margin: 0; }
  .outer-wrapper .axis path, .outer-wrapper .axis line {
    fill: none;
    stroke: #666;
    shape-rendering: crispEdges; }
  .outer-wrapper .axis text {
    font-family: sans-serif;
    fill: #666;
    font-size: 13px;
    shape-rendering: crispEdges; }
  .outer-wrapper .scale {
    margin-left: 30px; }
  .outer-wrapper .palette {
    border-left: 20px solid;
    padding-left: 4px;
    display: inline-block;
    margin: 10px; }

</style>
<div class="status-message">
	<p>This interactive graphic requires a modern browser (e.g. Chrome, Safari, Firefox or Internet Explorer 9+) with javascript enabled.</p>
	<p>The Thomson Reuters top 100 cited papers can be downloaded here: <a href="http://www.nature.com/polopoly_fs/7.21247!/file/WebofSciencetop100.xlsx" title="Download Web of Science Top 100.xls 26K" class="file-icon xls-icon">Web of Science Top 100.xls</a></p>
</div>

<div class="outer-wrapper" id="idc-graphic">
	<h2>Negotiated Indirect Cost vs Actual Calculated Indirect Cost</h2>

	<div class="chart"></div>

	<div class="scale"></div>

</div>
<!--[if gt IE 8]><!-->
<script type="text/javascript">
function extendObject (myObject) {
	/*	Referenced from: http://addyosmani.com/resources/essentialjsdesignpatterns/book/#observerpatternjavascript */
	
	/*	Storage for topics that can be broadcast or listened to */
	var topics = {};

	/*	A topic identifyer */
	var subUid = -1;

	/*	Publish or broadcast events of interest
		with a specific topic name and arguments
		such as the data to pass along */
	myObject.publish = function ( topic, args ) {
		
		if ( !topics[topic] ) {
			return false;
		}

		var subscribers = topics[topic];
		var len = subscribers ? subscribers.length : 0;

		while (len--) {
			subscribers[len].func( topic, args );
		}	

		return this;
	};

	/*	Subscribe to events of interest with a specific topic name and a 
		callback function, to be executed with the topic/event is observed */
	myObject.subscribe = function ( topic, func, parent ) {
		
		if ( !topics[topic] ) {
			topics[topic] = [];
		}

		var token = ( ++subUid ).toString();
		topics[topic].push({
			token: token,
			func: func,
			parent: parent
		});
		return token;
	};

}
function buildParams () {
	var params = {};

	params.colour =  ["#e41a1c","#377eb8","#a65628","#984ea3"];

	/*	Margin, Width and height */
	params.margin = {top: 20, right: 20, mid: 30, bottom: 50, left: 50};
	params.brushThickness = 60;
	params.width = jQuery('.section').width()  - params.margin.left - params.brushThickness - params.margin.mid - params.margin.right;
	params.height = jQuery('.section').width() - params.margin.top - params.margin.mid - params.brushThickness - params.margin.bottom;
	/*	Global variable to control the length of D3 transitons */
	params.duration = 450;
	params.delay = 450;

	return params;

}

BuildWidget.prototype.buttonClick = function() {
	var self = this;

};

BuildWidget.prototype.upDateButtons = function () {
	var self = this;
};
function buildData (data) {
		
	for (var i = 0; i < data.length; i++) {
		data[i].FY12 = data[i].FY12.length > 0 ? parseFloat(data[i].FY12) : 0;
		
		data[i].FY13 = data[i].FY13.length > 0 ? parseFloat(data[i].FY13) : 0;
		data[i].calculated_indirect_cost = parseFloat(data[i].calculated_indirect_cost);

		data[i].direct_cost = parseInt(data[i].direct_cost, 10);
		data[i].indirect_cost = parseInt(data[i].indirect_cost, 10);
		data[i].funding = parseInt(data[i].funding, 10);
	}


	return data;
}
function BuildWidget (target, params, data) {
	this.target = target;
	this.params = params;
	this.data = data;
}


BuildWidget.prototype.buildScales = function () {
	
	var minValue = d3.min(this.data, function(d) { 
		return d.funding; 
	});
	
	var maxValue = d3.max(this.data, function(d) { 
		return d.funding; 
	});

	this.yScale = d3.scale.linear()
					.range([this.params.height, 0])
					.domain([0,100]);

	this.yBrushScale = d3.scale.linear()
					.range([this.params.height, 0])
					.domain([0,100]);

	this.xScale = d3.scale.linear()
					.range([0, this.params.width])
					.domain([0,100]);

	this.xBrushScale = d3.scale.linear()
					.range([0, this.params.width])
					.domain([0,100]);

	this.radiusScale = d3.scale.linear()
						.range([2,15])
						.domain([minValue, maxValue]);

};

BuildWidget.prototype.buildGraphic = function () {
	this.svg = d3.select(this.target  + " > .chart").append("svg")
		.attr("width", this.params.width + this.params.margin.left + this.params.brushThickness + this.params.margin.mid + this.params.margin.right)
		.attr("height", this.params.height + this.params.margin.top + this.params.brushThickness + this.params.margin.mid + this.params.margin.bottom);

	var clip = this.svg.append("defs").append("svg:clipPath")
					.attr("id", "clip")
				  .append("svg:rect")
					.attr("id", "clip-rect")
					.attr("x", "0")
					.attr("y", "0")
					.attr("width", this.params.width)
					.attr("height", this.params.height);


	this.scatterGroup = this.svg.append("g")
						.attr("class","scatterGroup")
						.attr("clip-path", "url(#clip)")
						.attr("transform","translate(" + (this.params.margin.left + this.params.brushThickness + this.params.margin.mid) + "," + this.params.margin.top + ")");

	this.xBrushGroup = this.svg.append("g")
						.attr("class","xBrushGroup")
						.attr("transform","translate(" + (this.params.margin.left + this.params.brushThickness + this.params.margin.mid) + "," + (this.params.margin.top + this.params.height + this.params.margin.mid)+ ")");

	this.yBrushGroup = this.svg.append("g")
						.attr("class","yBrushGroup")
						.attr("transform","translate(" + this.params.margin.left + "," + this.params.margin.top + ")");


};

BuildWidget.prototype.buildAxes = function () {
	this.yAxis = d3.svg.axis()
					.scale(this.yScale)
					.tickSize(3,0)
					.orient("left");

	this.xAxis = d3.svg.axis()
					.scale(this.xScale)
					.tickSize(3,0)
					.orient("bottom");

	/* Prepare the y axis */
	this.svg.append("g")
		.attr("class", "y axis")
		.attr("transform", "translate(" + (this.params.margin.left + this.params.brushThickness + this.params.margin.mid) + "," + this.params.margin.top + ")")
		.call(this.yAxis);

	this.svg.append("g")
		.attr("class", "y-brush axis")
		.attr("transform", "translate(" + this.params.margin.left + "," + this.params.margin.top + ")")
		.call(this.yAxis)	
	  .append("g")
		.attr("class", "axisLabel")
	  .append("text")
		.attr("transform", "translate(" + -(this.params.margin.left * 0.6) + "," + (this.params.height / 2) + "), rotate(-90)")
		.style("text-anchor", "middle")
		.text("Actual Indirect Cost (%)");

	/*	Prepare the x axis */
	this.svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(" + (this.params.margin.left + this.params.brushThickness + this.params.margin.mid) + "," + (this.params.margin.top + this.params.height) + ")")
		.call(this.xAxis)

	this.svg.append("g")
		.attr("class", "x-brush axis")
		.attr("transform", "translate(" + (this.params.margin.left + this.params.brushThickness + this.params.margin.mid) + "," + (this.params.margin.top + this.params.height + this.params.margin.mid + this.params.brushThickness) + ")")
		.call(this.xAxis)	
	  .append("g")
		.attr("class","axisLabel")
	  .append("text")
		.attr("transform", "translate(" + (this.params.width / 2) + "," + (this.params.margin.bottom * 0.7) + ")")
		.style("text-anchor","middle")
		.text("Negotiated Indirect Cost (%)");

};

BuildWidget.prototype.buildBrush = function () {
	var self = this;

	var updateView = function () {
		self.updateScatterPlot();
		self.svg.selectAll(".x.axis").call(self.xAxis);
		self.svg.selectAll(".y.axis").call(self.yAxis);

	};

	var xDisplay = function () {
		var extent = xBrush.extent();

		self.xScale.domain(extent);

		updateView();
	};

	var xBrushend = function () {
		if (xBrush.extent()[0] === xBrush.extent()[1]) {
			d3.select(this).call(xBrush.extent([0, 100]));
			self.xScale.domain([0,100]);

			updateView();
		}
	};

	var yDisplay = function () {
		var extent = yBrush.extent();

		self.yScale.domain(extent);

		updateView();
		
	};

	var yBrushend = function () {
		if (yBrush.extent()[0] === yBrush.extent()[1]) {
			d3.select(this).call(yBrush.extent([0, 100]));
			self.yScale.domain([0,100]);

			updateView();
		}
	};

	var xBrush = d3.svg.brush()
					.x(this.xBrushScale)
					.extent([0, 100])
					.on("brush", xDisplay)
					.on("brushend", xBrushend);

	var yBrush = d3.svg.brush()
					.y(this.yBrushScale)
					.extent([0,100])
					.on("brush", yDisplay)
					.on("brushend", yBrushend)

	this.xBrushGroup.append("g")
		.attr("class", "brush")
		.call(xBrush)
		.selectAll("rect")
		.attr("fill","#999")
		.attr("height", this.params.brushThickness );

	this.yBrushGroup.append("g")
		.attr("class", "brush")
		.call(yBrush)
		.selectAll("rect")
		.attr("fill", "#999")
		.attr("width", this.params.brushThickness)


};

BuildWidget.prototype.enterScatterPlot = function () {
	var self = this;

	var typeOfOrg = ["Higher Ed", "Hosp", "NP res inst", "Other"];

	this.scatterGroup.selectAll("circle")
			.data(this.data, function (d) {
				return d.organization_name;
			})
			.enter()
		  .append("circle")
			.attr("cx", function (d) {
				return self.xScale(d.FY13);
			})
			.attr("cy", function (d) {
				return self.yScale(d.calculated_indirect_cost);
			})
			.attr("r", function (d) {
				return self.radiusScale(d.funding);
			})
			.attr("opacity", 0.8)
			.attr("fill", function (d) {
				if (d.institution_type === "Higher Ed") {
					return self.params.colour[0];
				} else if (d.institution_type === "Hosp") {
					return self.params.colour[1];
				} else if (d.institution_type === "NP res inst") {
					return self.params.colour[2];
				} else {
					return self.params.colour[3];
				}
			});

	d3.select(".scale")
	  .append("ul")
		.selectAll("li")
		.data(typeOfOrg)
		.enter()
	  .append("li")
		.attr("class", "palette")
		.attr("title", function(d) { return d.key; })
		.text(function(d) {
			return d;
		})
		.style("border-color", function(d,i) { 
			return self.params.colour[i];
		});
};

BuildWidget.prototype.updateScatterPlot = function () {
	var self = this;

	this.scatterGroup.selectAll("circle")
			.attr("cx", function (d) {
				return self.xScale(d.FY13);
			})
			.attr("cy", function (d) {
				return self.yScale(d.calculated_indirect_cost);
			});

};

(function() {
		var init = function($)
		{
		/*	Both jQuery and D3 are available so hide the status message and show the graphic */
		$(".status-message").css("display","none");
		$(".outer-wrapper").css("display","block");

			/*	Load D3 */
			$.getScript("http://www.nature.com/polopoly_static/js/d3.v3.min.js", function() {


				d3.csv("data/costs-basic.csv", function (data) {
					var params = buildParams();

					var idcData = buildData(data);			

					var idcGraphic = new BuildWidget("#idc-graphic", params, idcData);

					idcGraphic.buildGraphic();
					idcGraphic.buildScales();
					idcGraphic.buildAxes();
					idcGraphic.buildBrush();
					idcGraphic.enterScatterPlot();
				});

			}); /* End of d3js getscript call

		/* End of active code */
		};

	setTimeout(function()
	{
	if (typeof jQuery !== 'undefined')
	{
		init(jQuery);
	} else
	{
		setTimeout(arguments.callee, 60);
	}
	}, 60);

})();
</script>
<!--<![endif]-->